<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <!-- jquery-weui -->
    <link href="//cdn.bootcss.com/weui/1.1.1/style/weui.min.css" rel="stylesheet">
    <link href="//cdn.bootcss.com/jquery-weui/1.0.0/css/jquery-weui.min.css" rel="stylesheet">
    <!-- icons -->
    <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="res/icons.css" rel="stylesheet">
    <!-- custom -->
    <title>招标123</title>
    <style>
        html, body { height: 100%; background-color: #fbf9fe; }
        .weui-tabbar .fa { font-size: 24px; color: #10AEFF; }
        #list .weui-cells { margin-top: 0px; }
        #list .weui-cell { padding: 12px 5px 5px 5px;}
        #list .vip_tip, #list .empty_tip { padding-top: 10px; padding-bottom: 10px; }
        #list .vip_tip li { color: #00E; }
        #list .weui-media-box { padding: 0 0 0 3px; }
        #list .weui-media-box__info { margin-top: 5px; }
        #list .weui-cell__ft { padding-right: 8px; }
        #list .fa {
            font-size: 22px; color: #fff; background-color: #09BB07;
            font-weight: bold; margin-right: 3px; padding: 3px;
        }
        #list .weui-loadmore { margin-top: 5px; margin-bottom: 60px; }
        #list .weui-loadmore_line { margin-top: 20px; margin-bottom: 50px; }
        #rule .weui-panel__hd { padding-bottom: 3px; }
        #rule .button_sp_area { padding: 5px 5px 0 5px; }
        #rule .weui-btn_mini { margin: 0 5px 0 0; line-height: 2.1; padding: 0 8px;}
        /* 详情页弹出 */
        #content_popup, #content_popup .weui-popup__modal {z-index: 800;}
        /*#rule button { margin: 15px; } */
        /*.weui-tabbar { z-index: 10; }*/
        /*.popup-bottom, .popup-bottom weui-popup__overlay { z-index: 600; } */
        /*.weui-actionsheet__action { position: relative; width:100%; bottom: 0px; } */
        #search { z-index: 100; position: fixed; top: 0; width: 100%; }
    </style>
</head>
<body>

<div class="weui-tab" id="app">
  <div class="weui-tab__bd">
    <!-- start search bar -->
    <div id="search" class="weui-search-bar" :class="{'weui-search-bar_focusing': params.key}" v-if="view=='list'">
      <form class="weui-search-bar__form" @submit.prevent="key_search">
        <div class="weui-search-bar__box">
          <i class="weui-icon-search"></i>
          <input type="search" class="weui-search-bar__input" placeholder="搜索" v-model="params.key" required>
          <a href="javascript:" class="weui-icon-clear" @click="params.key=null"></a>
        </div>
        <label class="weui-search-bar__label">
          <i class="weui-icon-search"></i>
          <span>搜索</span>
        </label>
      </form>
      <a href="javascript:" class="weui-search-bar__cancel-btn" @click="key_search">搜索</a>
    </div>
    <!-- end search bar -->
    <div id="list" class="weui-tab__bd-item weui-tab__bd-item--active">
      <!-- list -->
      <template>
        <div class="weui-panel">
            <div class="weui-panel__bd" style="margin-top: 42px;">
              <div class="weui-media-box weui-media-box_small-appmsg">
                <div class="weui-cells" v-for="x of items">
                    <template v-if="x.uuid">
                        <a class="weui-cell weui-cell_access" :class="{'weui-btn_primary': x.uuid==archive.uuid}"
                           href="javascript:;" @click="view_content(x)">
                            <div class="weui-cell__hd"><i :class="['fa', 'icon-' + x.source]"></i></div>
                            <div class="weui-cell__bd weui-cell_primary">
                                <div class="weui-media-box weui-media-box_text">
                                <p v-html="highlight(x.title)"></p>
                                <ul class="weui-media-box__info">
                                  <li class="weui-media-box__info__meta">{{ x.subject }}</li>
                                  <li class="weui-media-box__info__meta" style="float: right;">{{ x.day }}</li>
                                </ul>
                                </div>
                            </div>
                            <span class="weui-cell__ft"></span>
                        </a>
                    </template>
                    <template v-else-if="x.vip">
                        <a class="weui-cell weui-cell_access vip_tip" href="javascript:;" @click="view='user'">
                            <div class="weui-cell__bd weui-cell_primary">
                                <div class="weui-media-box weui-media-box_text">
                                    <ul class="weui-media-box__info">
                                      <li class="weui-media-box__info__meta">{{ x.day }}</li>
                                      <li class="weui-media-box__info__meta">
                                        开通VIP会员可查看近三天的信息
                                        <span v-if="x.count > 0" class="weui-badge" style="color:yellow;">{{ x.count }}</span>
                                      </li>
                                    </ul>
                                </div>
                            </div>
                            <span class="weui-cell__ft"></span>
                        </a>
                    </template>
                    <template v-else-if="x.day">
                        <a class="weui-cell weui-cell_access empty_tip" href="javascript:;">
                            <div class="weui-cell__bd weui-cell_primary">
                                <div class="weui-media-box weui-media-box_text">
                                    <ul class="weui-media-box__info">
                                      <li class="weui-media-box__info__meta">{{ x.day }}</li>
                                      <li class="weui-media-box__info__meta">
                                          {{ params.filter ? '当日没有符合您筛选条件的信息' : '当日无招标信息' }}
                                      </li>
                                    </ul>
                                </div>
                            </div>
                        </a>
                    </template>
                    <template v-else>
                        <a class="weui-cell weui-cell_access" href="javascript:;">
                            <div class="weui-cell__bd weui-cell_primary">
                                <div class="weui-media-box weui-media-box_text">
                                    <ul class="weui-media-box__info">
                                      <li class="weui-media-box__info__meta">{{ x.title }}</li>
                                    </ul>
                                </div>
                            </div>
                        </a>
                    </template>
                </div>
              </div>
            </div>
        </div>
        <!-- footer -->
        <template v-if="next">
            <div class="weui-loadmore">
              <i class="weui-loading"></i>
              <span class="weui-loadmore__tips">正在加载</span>
            </div>
        </template>
        <template v-else-if="items.length > 0">
            <template v-if="is_vip">
                <div class="weui-loadmore weui-loadmore_line">
                    <span class="weui-loadmore__tips">没有更多了</span>
                </div>
            </template>
            <template v-else>
                <div class="weui-loadmore weui-loadmore_line">
                    <a href="javascript:;" class="weui-loadmore__tips" style="color:#00E" @click="view='user'">开通VIP服务查看更多信息</a>
                </div>
            </template>
        </template>
      </template>
    </div>
    <div id="rule" class="weui-tab__bd-item">
        <rule-tab id="rule-page" :vip="is_vip" :sources="rule.sources" :subjects="rule.subjects" :keys="rule.keys"
                  @select="rule_select" @submit="rule_submit" @cancel="view='list'"></rule-tab>
    </div>
    <div id="user" class="weui-tab__bd-item">
        <user-tab id="user-page" :vip="is_vip" :end="user.end" :pays="user.pays" :photo="user.photo"
                  @submit="init()" @cancel="view='list'"></user-tab>
    </div>
  </div>
  <div class="weui-tabbar">
    <a id="btn_all" href="javascript:;" class="weui-tabbar__item" @click="view_all">
      <div class="weui-tabbar__icon">
        <i class="fa fa-university"></i>
      </div>
      <p class="weui-tabbar__label">全国信息</p>
    </a>
    <a id="btn_rule" href="javascript:;" class="weui-tabbar__item weui-bar__item--on" @click="view='rule'">
      <div class="weui-tabbar__icon">
        <i class="fa fa-check-square-o"></i>
      </div>
      <p class="weui-tabbar__label">筛选定制</p>
    </a>
    <a id="btn_day" href="javascript:;" class="weui-tabbar__item" @click="day_pop">
      <div class="weui-tabbar__icon">
        <i class="fa fa-calendar"></i>
      </div>
      <p class="weui-tabbar__label">发布日期</p>
    </a>
    <a id="btn_user" href="javascript:;" class="weui-tabbar__item" @click="view='user'">
        <span v-if="!is_vip" class="weui-badge weui-badge_dot" style="position:absolute; top:0.2em; right:2.2em;"></span>
        <div class="weui-tabbar__icon">
        <i class="fa fa-user"></i>
      </div>
      <p class="weui-tabbar__label">会员信息</p>
    </a>
  </div>
    <!-- content popup -->
    <content-pop id="content_popup" :archive="archive" :vip="is_vip" @original="on_original"></content-pop>
</div>

</div>
<!-- vue -->
<script src="//cdn.bootcss.com/vue/2.1.10/vue.min.js"></script>
<script src="//cdn.bootcss.com/vue-resource/1.2.0/vue-resource.min.js"></script>

<!-- jquery-weui -->
<script src="//cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
<script src="//cdn.bootcss.com/jquery-weui/1.0.0/js/jquery-weui.min.js"></script>

<!-------------------------------------------- VUE COMPONENTS --------------------------------------------------------->
<template id="content-pop">
    <div :id="id" class="weui-popup__container">
      <div class="weui-popup__overlay"></div>
      <div class="weui-popup__modal" style="overflow-x: auto;">
        <article class="weui-article" >
            <h1><b>{{ archive.title }}</b></h1>
            <section v-for="x in archive.contents">
                <p v-html="hide(x)"></p>
            </section>
            <section v-show="archive.url != ''" >
                <a href="javascript:;" @click="original(archive.url, archive.source)">查看原文
                    <span v-if="!vip" class="weui-badge" style="position:relative; top:-0.6em; color:yellow;">vip</span>
                </a>
            </section>
            <section>
                <a href="javascript:;" class="weui-btn weui-btn_primary close-popup">关闭</a>
            </section>
        </article>
        <div class="weui-btn-area"></div>
      </div>
    </div>
</template>
<script>
    Vue.component('content-pop', {
        template: '#content-pop',
        props: {id: String, archive: Object, vip: Boolean},
        methods: {
            original: function (url, source) {  // 查看原始信息
                this.$emit('original', this, url);
            },
            hide: function(val){
                if (this.vip){ return val; }
                var sites = ['采购与招标网', '招标投标管理信息平台', '交易网', '交易信息网', '交易服务中心', '交易服务网',
                    '建设网', '网站',
                ];
                var patterns = [
                    {name: '链接', pattern: /<a .+>(.+)<\/a>/g, replace:'<a href="javascript:confirm_vip();">$1</a>'},
                    // {name: '邮箱', pattern: /\w+([-+.]\w+)*@\w+([-.]\w+)*(\.\w+([-.]\w+)*)/g, replace: '****@****$3'},
                    // {name: '手机', pattern: /\D(1[3|4|5|7|8]\d)\d{8}/g, replace: '$1********'},
                    // {name: '座机', pattern: /\D(0\d{2,3}-)(\d{6,8})/g, replace: '$1********'},
                    // {name: '网址', pattern: /(http:\/\/)?([a-zA-Z][\w-]+\.)+/g, replace: '$1********.'},
                    // {name: '网站', pattern: new RegExp('[\u4e00-\u9fa5]{2,8}('+ sites.join('|') +')', 'g'),
                    //    replace: '******'},
                    // {name: '公司', pattern: /.{4,8}(有限责任公司|有限公司|公司)/g, replace: '******$1'},
                ];
                patterns.forEach(function(p){
                    val = val.replace(p.pattern, p.replace);
                });
                return val;
            }
        },
        updated: function(){
            var vm = this;
            setTimeout(function(){
                var selector = '#' + vm.id + ' > div.weui-popup__modal';
                $(selector).scrollTop(0);
            }, 0);
        }
    });
</script>

<template id="rule-tab">
    <div class="weui-panel weui-panel_access">
        <!-- start search bar -->
        <div class="weui-search-bar">
          <form class="weui-search-bar__form" @submit.prevent="add_key">
            <div class="weui-search-bar__box">
              <i class="weui-icon-search"></i>
              <input type="search" class="weui-search-bar__input" id="searchInput" required
                     placeholder="请输入要搜索的词" v-model="key">
              <a href="javascript:" class="weui-icon-clear"></a>
            </div>
            <label class="weui-search-bar__label" id="searchText">
              <i class="weui-icon-search"></i><span>添加搜索词</span>
            </label>
          </form>
          <a href="javascript:" class="weui-search-bar__cancel-btn" @click="add_key">添加</a>
        </div>
        <!-- end search bar -->
        <div class="weui-panel__hd">搜索词</div>
        <div class="weui-panel__bd button_sp_area">
        <template v-for="x of keys">
            <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default"
               :class="{'weui-btn_primary': x.select}" @click="select(x)" >{{ x.text }}</a>
        </template>
        </div>
        <div class="weui-panel__hd">公告类型</div>
        <div class="weui-panel__bd button_sp_area">
            <template v-for="x of subjects">
                <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default"
                   :class="{'weui-btn_primary': x.select}" @click="select(x)" >{{ x.text }}
                    <template v-if="(x.text == '预公告') && (!vip)">
                        <span class="weui-badge weui-badge_dot" style="position:relative; top:-0.6em;"></span>
                    </template>
                </a>
            </template>
        </div>
        <div class="weui-panel__hd">信息来源</div>
        <div class="weui-panel__bd button_sp_area">
            <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default"
               :class="{'weui-btn_primary': all.length == 0}" @click="global()" >全国</a>
            <template v-if="expand">
                <template v-for="x of sources">
                    <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default"
                       :class="{'weui-btn_primary': x.select}" @click="select(x)" >{{ x.text }}</a>
                </template>
                <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default"
                   @click="expand=false" >{{ '< 收起' }}</a>
            </template>
            <template v-else>
                <template v-for="x of all">
                    <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default"
                       :class="{'weui-btn_primary': x.select}" @click="select(x)" >{{ x.text }}</a>
                </template>
                <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default"
                   @click="expand=true" >{{ '更多 >' }}</a>
            </template>
        </div>
        <!-- buttons -->
        <div class="weui-panel__bd">
            <p class="weui-btn-area" style="margin-bottom: 65px;">
              <a href="javascript:;" class="weui-btn weui-btn_primary" @click="submit">完成</a>
              <a href="javascript:;" class="weui-btn weui-btn_default" @click="cancel">取消</a>
            </p>
        </div>
    </div>
</template>
<script>
    Vue.component('rule-tab', {
        template: '#rule-tab',
        props: {id: String, vip:Boolean, sources: Array, subjects: Array, keys: Array, key: String},
        data: function(){
            return { expand: false };
        },
        computed: {
            all: function(){
                return this.sources.filter(function(x){ return x.select; });
            }
        },
        methods: {
            select: function(item){
                item.select = !item.select;
                if (item.select){
                    this.$emit('select', this, item);
                }
            },
            global: function(){ // 选中全国
                this.sources.forEach(function(x){ x.select = false; });
            },
            add_key: function () {
                var vm = this;
                var key = vm.key;
                if (!key || key.length < 1) return;
                vm.keys = $.grep(vm.keys, function(v) { return v.text != key; });
                vm.keys.splice(0, 0, {text: key, select: true});
            },
            submit: function(){
                this.add_key();
                this.expand = false;
                this.$emit('submit', this);
            },
            cancel: function(){ this.$emit('cancel', this); }
        }
    });
</script>

<template id="user-tab">
    <div class="weui-msg" v-if="vip">
      <div class="weui-msg__text-area">
        <h2 class="weui-msg__title">会员信息</h2>
        <p>&nbsp;</p>
        <p class="weui-msg__desc">
            <img :src="photo" style="width:200px; height:200px; "></img>
        </p>
      </div>
        <div class="weui-form-preview" v-for="x of pays">
          <div class="weui-form-preview__hd">
            <label class="weui-form-preview__label">付款金额</label>
            <em class="weui-form-preview__value">¥{{ x.fee }}.00</em>
          </div>
          <div class="weui-form-preview__bd">
            <div class="weui-form-preview__item">
              <label class="weui-form-preview__label">支付日期</label>
              <span class="weui-form-preview__value">{{ x.day }}</span>
            </div>
            <div class="weui-form-preview__item">
              <label class="weui-form-preview__label">到期时间</label>
              <span class="weui-form-preview__value">{{ x.end }}</span>
            </div>
            <div class="weui-form-preview__item">
              <label class="weui-form-preview__label">订单编号</label>
              <span class="weui-form-preview__value">{{ x.order }}</span>
            </div>
          </div>
        </div>
      <div class="weui-msg__extra-area" style="margin-bottom: 60px;">
        <div class="weui-footer">
            <p class="weui-footer__links"><a href="javascript:;" class="weui-footer__link">服务提供商</a></p>
            <p class="weui-footer__text">天津贝叶斯科技有限公司</p>
        </div>
      </div>
    </div>
    <div class="weui-msg" v-else>
      <div class="weui-msg__text-area">
        <h2 class="weui-msg__title">开通VIP服务</h2>
        <p class="weui-msg__desc">VIP用户年费300元/年</p>
        <p class="weui-msg__desc">&nbsp;</p>
        <p class="weui-msg__desc"></p>
        <p class="weui-msg__desc" style="color: #000;">请长按扫描二维码完成支付</p>
        <p class="weui-msg__desc"><img src="/wx/pay" style="width:50%; margin-top: 10px;" /></p>
      </div>
      <div class="weui-msg__opr-area">
        <p class="weui-btn-area">
          <a href="javascript:;" class="weui-btn weui-btn_primary" @click="submit">完成</a>
        </p>
      </div>
      <div class="weui-msg__extra-area" style="margin-bottom: 60px;">
        <div class="weui-footer">
            <p class="weui-footer__links"><a href="javascript:;" class="weui-footer__link">服务提供商</a></p>
            <p class="weui-footer__text">天津贝叶斯科技有限公司</p>
        </div>
      </div>
    </div>
</template>
<script>
    Vue.component('user-tab', {
        template: '#user-tab',
        props: {id: String, vip: Boolean, end: String, pays: Array, photo: String},
        methods: {
            submit: function(){ this.$emit('submit', this); },
            cancel: function(){ this.$emit('cancel', this); }
        }
    });
</script>

<template id="period-pop">
    <div :id="id" @class>
        <div class="weui-mask weui-actions_mask weui-mask--visible" style="opacity: 0.8; z-index:800;"></div>
        <div class="weui-actionsheet__title">请选择日期区间</div>
        <div class="weui-actionsheet weui-actionsheet_toggle">
            <div class="weui-actionsheet__menu">
                <div class="weui-actionsheet__cell" :class="{'bg-primary': select=='week'}" @click="submit(week)">最近一周</div>
                <div class="weui-actionsheet__cell" @click="submit(month)">最近一个月</div>
                <div class="weui-actionsheet__cell" @click="submit(three)">最近三个月</div>
            </div>
            <div class="weui-actionsheet__action">
                <div class="weui-actionsheet__cell" @click="cancel()">取消</div>
            </div>
        </div>
    </div>
</template>
<script>
    Vue.component('period-pop', {
        template: '#period-pop',
        props: {id: String, vip: Boolean},
        data: function(){
            month = new Date(); month.setDate(new Date().getDate() - 30);
            three = new Date(); three.setDate(new Date().getDate() - 90);
            return {
                visible: false,
                select: 'week',
                week: '',
                month: month.toISOString().substring(0, 10),
                three: three.toISOString().substring(0, 10)
            }
        },
        methods: {
            show: function(){
                $('#' + this.id).show();
            },
            submit: function(day){
                this.$emit('submit', this, day);
            },
            cancel: function(){
                $('#' + this.id).hide();
            }
        }
    });
</script>
<!------------------------------------------END VUE COMPONENTS -------------------------------------------------------->

<script>
    vm_app = new Vue({
        el: '#app',
        data: {
            view: 'list',
            rule: {sources:[], keys:[]},                        // 筛选规则
            user: {vip: false, end: '', pays:[], photo: ''},    // 用户信息(是否vip, 到期时间, 支付记录)
            params: {day: '', filter: true, key:null},            // 请求参数(起始日期，是否过滤，搜索词)
            next: null,                                         // 下一页的请求参数
            items: [],                                          // 标题列表
            archive : {uuid: null, title:'', url:'', contents:[]},      // 弹出的正文详情
            loading: false
        },
        computed: {
            is_vip: function () { return this.user.vip; },
            search_focus: function() { return 'weui-search-bar_focusing'; }
        },
        watch: {
            loading: function(val){ val ? $.showLoading() : $.hideLoading(); },
            'view': 'update_view',
            'params.filter': 'update_view'
        },
        methods: {
            init: function(){
                var vm = this;
                vm.loading = true;
                vm.$http.get('/api/v4/user').then(function(resp){
                    vm.loading = false;
                    var data = resp.body;
                    vm.rule = data.rule;
                    vm.user = data.user;
                    vm.params.cache = data.cache;
                    vm.reload();
                }, function(){ vm.loading = false; });
            },
            reload: function(){
                var vm = this;
                vm.view = 'list';
                vm.loading = true;
                var params = $.extend({}, vm.params, {'_': Math.random()});
                vm.$http.get('/api/v4/titles', {params: params}).then(function(resp){
                    vm.loading = false;
                    var data = resp.body;
                    vm.items = data.items;
                    vm.next = data.next;
                    setTimeout(function () {
                        $('#list').scrollTop(0);
                        $('#list').trigger('scroll');
                    }, 0);
                }, function(){ vm.loading = false; });
            },
            append: function(){
                var vm = this;
                if (!vm.next) return;
                if (vm.appending) return;
                vm.appending = true;
                vm.next.cache = vm.params.cache;
                vm.$http.get('/api/v4/titles', {params: vm.next}).then(function(resp){
                    vm.appending = false;
                    var data = resp.body;
                    vm.next = data.next;
                    Array.prototype.push.apply(vm.items, data.items);
                    setTimeout(function () {
                        $('#list').trigger('scroll');
                    }, 0);
                }, function(){ vm.appending = false; });
            },
            view_content: function(x){
                var vm = this;
                vm.archive.uuid = x.uuid;
                vm.loading = true;
                vm.$http.get('/api/v4/content/'+x.uuid).then(function(resp){
                    vm.loading = false;
                    vm.archive = resp.body;
                    vm.archive.title = x.title;
                    $('#content_popup').popup();
                    history.pushState(null, null, document.URL);
                }, function(){ vm.loading = false; });
            },
            on_original: function(comp, url){
                var vm = this;
                if (vm.is_vip) {
                    window.location.href = url;
                }
                else {
                    $.confirm('开通VIP服务查看<b>原文信息</b><br/>现在开通?', function(){
                        $.closePopup();
                        vm.view = 'user';
                    });
                }
            },
            update_view: function(){
                var vm = this;

                // tab view state
                $('.weui-tab__bd-item').removeClass('weui-tab__bd-item--active');
                $('#' + vm.view).addClass('weui-tab__bd-item--active');
                if (vm.view != 'list'){ history.pushState(null, null, document.URL); }

                // tab button state
                var on = 'weui-bar__item--on';
                $('.weui-tabbar__item').removeClass(on);
                switch (vm.view) {
                    case 'list': $(vm.params.filter ? '#btn_rule' : '#btn_all').addClass(on); break;
                    case 'rule': $('#btn_rule').addClass(on); break;
                    case 'user': $('#btn_user').addClass(on); break;
                }

                // search bar
                vm.params.key = vm.params.filter ? null : vm.params.key;
            },
            view_all: function(){
                var vm = this;
                vm.params.filter = false;
                vm.reload();
            },
            day_pop: function(){
                var vm = this;

                var badge = '<span class="weui-badge weui-badge_dot" style="position:relative; top:-0.6em;"></span>';
                if (vm.is_vip) { badge = ''; }
                if (!vm.action){ vm.action = 'week'; }

                $.actions({
                    title: '请选择发布日期',
                    actions: [{
                        text: "最近一周",
                        className: vm.action == 'week' ? 'bg-primary' : '',
                        onClick: function() {
                            setTimeout(function () {
                                vm.params.day = '';
                                vm.reload();
                                vm.action = 'week';
                            },0);
                        }
                    },{
                        text: "最近一个月" + badge,
                        className: vm.action == 'month' ? 'bg-primary' : '',
                        onClick: function() {
                            setTimeout(function () {
                                if (vm.is_vip) {
                                    var dt = new Date(); dt.setDate(new Date().getDate() - 30);
                                    vm.params.day = dt.toISOString().substring(0, 10);
                                    vm.reload();
                                    vm.action = 'month';
                                }
                                else {
                                    confirm_vip();
                                }
                            },0);
                        }
                    },{
                        text: "最近三个月" + badge,
                        className: vm.action == 'three' ? 'bg-primary' : '',
                        onClick: function() {
                            setTimeout(function () {
                                if (vm.is_vip) {
                                    var dt = new Date(); dt.setDate(new Date().getDate() - 90);
                                    vm.params.day = dt.toISOString().substring(0, 10);
                                    vm.reload();
                                    vm.action = 'three';
                                }
                                else {
                                    confirm_vip();
                                }
                            },0);
                        }
                    }]
                });
            },
            day_submit: function(comp){
                var vm = this;
                vm.params.day = comp.day;
                vm.reload();
            },
            rule_select: function(comp, item){
                var vm = this;
                if (vm.is_vip) { return; }
                if (item.text == '预公告' && item.select) {
                    item.select = false;
                    $.confirm('开通VIP服务查看<b>预公告</b>信息<br/>现在开通?', function(){
                        vm.view = 'user';
                    });
                }
            },
            rule_submit: function(comp){
                var choice = function(vals, invert) {
                    return $.grep(vals, function(o) { return o.select; }, invert)
                            .map(function(o) { return o.value ? o.value : o.text; });
                };
                var vm = this;
                var data = {
                    sources: choice(comp.sources),
                    subjects: choice(comp.subjects),
                    keys: choice(comp.keys),
                    suggests: comp.keys.map(function(o){ return o.text; })
                };
                vm.$http.post('/api/v4/user', data).then(function(resp){
                    $.toast("保存成功", 2000);
                    setTimeout(function () {
                        vm.params.filter = true;
                        vm.params.cache = resp.body.cache;
                        vm.init();
                    }, 2800);
                }, function(){ vm.loading = false; });
            },
            view_user: function(){
                var vm = this;
                vm.view = 'user';
            },
            key_search: function(){
                var vm = this;
                vm.params.filter = false;
                this.reload();
                var key = vm.params.key;
                if (key && key.length > 0) {
                    // 搜索框一直显示搜索词
                    var bar = $(event.target).parents('.weui-search-bar');
                    setTimeout(function(){
                       bar.addClass('weui-search-bar_focusing');
                    },0);
                    // 添加搜索词到筛选规则
                    vm.rule.keys = $.grep(vm.rule.keys, function(v) { return v.text != key; });
                    vm.rule.keys.splice(0, 0, {text: key, select: false});
                }
            },
            highlight: function(v){
                var vm = this;
                var keys = vm.rule.keys.filter(function (o) { return o.select; }).map(function(o){ return o.text;});
                keys = keys.concat([vm.params.key]);
                keys.forEach(function(k){
                    var reg = new RegExp(k, 'g');
                    var rep = '<b>' + k + '</b>';
                    v = v.replace(reg, rep);
                });
                return v;
            }
        },
        filters: {
        },
        mounted: function(){
            // 自定义提示框
            $.extend($.modal.prototype.defaults, {title: '温馨提示', buttonOK: '好的', buttonCancel: '再看看'});
        }
    });

    vm_app.init();

    // 滚动加载
    $('#list').infinite().on("infinite", function() {
        vm_app.append();
    });

    // 弹出详情页时防止回退
    window.addEventListener('popstate', function () {
        if ($('.weui-popup__container--visible').length > 0){
            $.closePopup();
        }
        else if (vm_app.view != 'list'){
            vm_app.view = 'list';
        }
        else {
            history.back();
        }
    });

    function confirm_vip(){
        $.confirm('开通VIP服务查看此项内容<br/>现在开通?', function(){
            vm_app.view = 'user';
            $.closePopup();
        });
    }

</script>

</body>
</html>